<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>添加订单-WeAdmin Frame型后台管理系统-WeAdmin 1.0</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../static/css/font.css">
    <link rel="stylesheet" href="../../static/css/weadmin.css">
    <script src="../../lib/layui/layui.js" charset="utf-8"></script>
</head>

<body>
<div class="weadmin-nav">
            <a href="">首页 / </a>
            <a href="">订单管理 / </a>
            <a>
                <cite>新增订单</cite>
            </a>
        <a class="layui-btn layui-btn-sm" style="line-height:1.6em;margin-top:3px;float:right" href="javascript:location.replace(location.href);"
            title="刷新">
            <i class="layui-icon" style="line-height:30px">ဂ</i>
        </a>
    </div>

    <div class="weadmin-body">
        <fieldset class="layui-elem-field order-form">
            <!-- TODO: 居中、调整表格 -->
            <legend>
                <h1>新增订单</h1>
            </legend>
            <div class="layui-field-box">
                <h2>联系方式</h2>
                <hr class="layui-bg-green">
                <form class="layui-form">
                    <div class="layui-form-item">
                        <label for="contacter" class="layui-form-label">
                            <span class="we-red">*</span>联系人
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="ordercontacter" name="order-contacter" placeholder="名称" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                        <label for="contacter" class="layui-form-label">
                            <span class="we-red">*</span>手机号
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="ordertel" name="order-tel" placeholder="手机号码" lay-verify="required|phone" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="contacter" class="layui-form-label">
                            <span class="we-red">*</span>公司名称
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="ordercomp" name="order-comp" placeholder="名称" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>

                        <label for="checker" class="layui-form-label">
                            <span class="we-red">*</span>审核人
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="check" name="check" placeholder="名称" lay-verify="required|name" autocomplete="off" class="layui-input">
                        </div>
                    </div>


                    <div class="layui-form-item">
                        <label for="begindate" class="layui-form-label">
                            <span class="we-red">*</span>下单日期
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="begindate" name="begindate" lay-verify="required|date" autocomplete="off" class="layui-input">
                        </div>
                        <label for="enddate" class="layui-form-label">
                            <span class="we-red">*</span>交付日期
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="enddate" name="enddate" lay-verify="required|date" autocomplete="off" class="layui-input">
                        </div>
                    </div>




                    <div class="layui-form-item">
                        <label for="receive-addr" class="layui-form-label">
                            <span class="we-red">*</span>收货地址
                        </label>
                        <div class="layui-input-inline">
                            <select name="province" id="province" lay-filter="province" lay-verify="required">
                                <option value="-1">请选择</option>
                                <option value="110000">北京市</option>
                                <option value="120000">天津市</option>
                                <option value="130000">河北省</option>
                                <option value="140000">山西省</option>
                                <option value="150000">内蒙古自治区</option>
                                <option value="210000">辽宁省</option>
                                <option value="220000">吉林省</option>
                                <option value="230000">黑龙江</option>
                                <option value="310000">上海市</option>
                                <option value="320000">江苏省</option>
                                <option value="330000">浙江省</option>
                                <option value="340000">安徽省</option>
                                <option value="350000">福建省</option>
                                <option value="360000">江西省</option>
                                <option value="370000">山东省</option>
                                <option value="410000">河南省</option>
                                <option value="420000">湖北省</option>
                                <option value="430000">湖南省</option>
                                <option value="440000">广东省</option>
                                <option value="450000">广西壮族自治区</option>
                                <option value="460000">海南省</option>
                                <option value="500000">重庆市</option>
                                <option value="510000">四川省</option>
                                <option value="520000">贵州省</option>
                                <option value="530000">云南省</option>
                                <option value="540000">西藏自治区</option>
                                <option value="610000">陕西省</option>
                                <option value="620000">甘肃省</option>
                                <option value="630000">青海省</option>
                                <option value="640000">宁夏回族自治区</option>
                                <option value="650000">新疆维吾尔自治区</option>
                                <option value="710000">台湾省</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="city" id="city" lay-filter="city" lay-verify="required">
                                <option></option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="district" id="district" lay-filter="district" lay-verify="required">
                                <option></option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="receive-addr" class="layui-form-label">
                            <span class="we-red">*</span>详细地址
                        </label>
                        <div class="layui-input-inline">
                            <textarea placeholder="详细地址" id="address" name="desc" class="layui-textarea" style="width:400%"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="fapiao" class="layui-form-label">
                            订单总额
                        </label>
                        <div class="layui-input-inline">
                            <input readonly="value" type="text" id="orderbill" name="orderbill" class="layui-input">
                        </div>
                        <label for="payment" class="layui-form-label">
                            支付方式
                        </label>
                        <div class="layui-input-inline">
                            <select name="payment" id="payment">
                                <option value="1">现金</option>
                                <option value="2">银行转账</option>
                                <option value="3">支票</option>
                                <option value="4">微信</option>
                                <option value="5">支付宝</option>
                            </select>
                        </div>
                    </div>



                    <h2>订单明细</h2>
                    <hr class="layui-bg-green">

                    <div class="layui-form-item">
                        <table class="layui-table" id="myTable">
                            <thead>
                                <tr>
                                    <th>货品编号</th>
                                    <th>商品名称</th>
                                    <th>单价</th>
                                    <th>数量</th>
                                    <th>总价</th>
                                    <th>操作</th>
                                </tr>

                            </thead>
                            <tbody>

                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>合计</td>
                                    <td colspan>人民币</td>
                                    <td></td>
                                    <td id="total_num"></td>
                                    <td id="total_price"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <a class="layui-btn layui-btn-sm" onclick="addTable();" id="addTable">
                            <i class="fas fa-plus"></i>+</a>
                    </div>
                    <div class="layui-form-item">
                        <textarea placeholder="备注：如有特殊需求，如 配送物流、加急订单等请在此注明" id="desc" name="desc" class="layui-textarea"></textarea>
                    </div>
                    <div class="layui-form-item">
                        <button class="layui-btn" lay-submit lay-filter="add">确定</button>
                    </div>
                </form>
            </div>
        </fieldset>

    </div>
</body>
<script>
    layui.use(['form', 'jquery', 'table', 'layer', 'laydate'], function () {
        var form = layui.form,
            $ = layui.jquery,
            table = layui.table,
            laydate = layui.laydate
        layer = layui.layer;
        that_form = form
        laydate.render({
            elem: '#enddate'
        });

        laydate.render({
            elem: '#begindate'
        });

        //获取数据
        function getData(type) {
            var post_data;
            var pdata;
            var province_id;
            var city_id;
            var req;

            if (type == 1) {
                req = "get-all-product";
                post_data = {
                    "req_type": "product"
                };
            }
            else if (type == 2) {
                req = "province"
                province_id = $('#province').val();
                post_data = {
                    "province_id": province_id
                };
            }
            else {
                req = "city"
                province_id = $('#province').val();
                city_id = $("#city").val();
                post_data = {
                    "province_id": province_id,
                    "city_id": city_id
                };
            }
            $.ajax({               
                url: "../../../order/" + req,
                type: "POST",
                cache: false,
                async: false,
                contentType: "application/json",
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                data: JSON.stringify(post_data),
                success: function (data) {
                    pdata = data;
                },
                error: function (err) {
                    console.log(err);
                    var msg
                    if (type == 1) {
                        msg = "获取产品信息失败，请刷新后重试"
                    } else if (type == 2) {
                        msg = "获取市级信息失败，请刷新后重试"
                    } else {
                        msg = "获取区级信息失败，请刷新后重试"
                    }
                    layer.msg(msg, {
                        icon: 5
                    })
                }
            })
            return pdata;
        };
        //reload table

        //监听提交
        form.on('submit(add)', function (data) {
            var comp_name = $("#ordercomp").val();
            var contacter = $("#ordercontacter").val();
            var tele_num = $("#ordertel").val();
            var begin_date = $("#begindate").val();
            var end_date = $("#enddate").val();
            var province = $("#province").val();
            var city = $("#city").val();
            //区级地址编码
            var district = $("#district").val();
            //address 详细地址
            var address = $('#address').val();
            var order_bill = $("#orderbill").val();
            var payment = $("#payment").val();
            var checker = $("#check").val();
            var receiveraddress = district + address


            var order_data = {
                "date": begin_date,
                "indentor": comp_name,
                "receiver": contacter,
                "checker": checker,
                "recevieraddress": receiveraddress,
                "indentorphonenumber": tele_num,
                "totalprice": order_bill,
                "status": 0,
                "deliverydate": end_date,
                "paymentway": payment,
            }

            var product = []
            for (var i = 1; i < num; i++) {
                product[i - 1] = {}
                product[i - 1]['product'] = $("#product" + (i)).val()
                product[i - 1]['number'] = $("#number" + (i)).val()
            }

            var order_info = {}
            order_info['order_data'] = order_data
            order_info['product'] = product
            //将数据传回后台
            $.ajax({
                type: "POST",
                url: "../../../order/add-order",
                cache: false,
                async: false,
                contentType: "application/json",
                dataType: "json",
                xhrFields: {
                    withCredentials: true
                },
                data: JSON.stringify(order_info),
                success: function (data) {
                    var msg, icon_num
                    layer.msg("订单添加中，请稍等",{
                        icon :6
                    })
                    if (data.result == 1) {
                        var newdata = {
                            "id": data.id,
                            "start_date": begin_date,
                            "indentor": comp_name,
                            "price": order_bill,
                            "status": "未完成",
                            "end_date": end_date,
                        }
                        parent.mdata.push(newdata)
                        var tabledata = parent.mdata
                        parent.tableIns.reload({
                            data: tabledata,
                            page:{
                                curr:1
                            }
                        })
                        msg = "订单添加成功"
                        icon_num = 6
                    } else if (data.result == 2) {
                        msg = "无用户权限"
                        icon_num = 5
                    } else {
                        msg = "无法添加数据，请求方式错误, 请刷新页面后重试"
                        icon_num = 5
                    }
                    layer.confirm(msg,
                        { icon: icon_num },
                        function () {
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index)
                        })
                },
                error: function (err) {
                    console.log(err);
                    layer.confirm("添加订单失败，请刷新页面后重试", {
                        icon: 5
                    })
                }
            })
            return false;
        });



        var num = 1;
        var price = [];
        var total = 0;
        var pro_data = {};
        var number = [];

        //动态添加订单明细
        window.addTable = function () {
            pro_data = getData(1);
            pro_data = JSON.parse(pro_data)
            var tableHtml = "";

            tableHtml += '<tr id="tr' + num + '">' +
                '<td>' + num + '</td>' +
                '<td><div class="layui-input-inline"><select lay-filter="product" id="product' + num + '" class="product"><option value="-1">请选择</option></select></div></td>' +
                '<td><div class="layui-input-inline"><a id="price' + num + '"></a></div></td>' +
                '<td><div class="layui-input-inline"><input type="text" readonly="value" placeholder="请输入" id="number' + num + '"class="layui-input" class="productnum"></input></div></td>' +
                '<td><div class="layui-input-inline"><a id="total' + num + '"></div></td>' +
                '<td><button class="layui-btn layui-btn-danger layui-btn-sm" onclick="removeTr(' + num + ')">删除</button>' +
                '</td>' +
                '</tr>';

            var elements = $("#myTable").children().length; //表示id为“mtTable”的标签下的子标签的个数    
            $("#myTable").children().eq(elements - 1).after(tableHtml); //在表头之后添加空白行
            //动态向select添加option
            for (var i in pro_data) {
                $('#product' + num).append('<option value="' + pro_data[i].pk + '">' + pro_data[i].fields.name + '</option>');
                price[pro_data[i].pk] = pro_data[i].fields.price
            }
            $('#price' + num).text(0)
            $('#number' + num).val(0)
            form.render("select");

            //动态监听input输入内容
            var $inputContainer = $('#myTable');
            $inputContainer.find('input').on('input proertychange', function () {
                var result = $(this).val();
                var id = $(this)[0].id;
                var curr = id.substr(6, id.length);
                var cur_price = $('#price' + curr).text();
                var total_price = cur_price * result;

                $('#total' + curr).text(cur_price * result);
                //total_num update
                var total_num = 0;
                var total_all = 0;
                for (var i = 1; i < num; i++) {
                    if ($('#number' + i).val() != "") {
                        total_num += parseInt($('#number' + i).val());
                        total_all += parseFloat($('#total' + i).text());
                    }
                }
                $('#total_num').text(total_num);
                $('#total_price').text(total_all);
                $('#orderbill').val(total_all);
                form.render();
            })
            num++;
        };

        //监听product select
        form.on('select(product)', function (data) {
            var id = $(data)[0].elem.id; //当前select的id
            var curr = id.substr(7, id.length); //当前行
            var data_pos = $('#' + id).val();//当前select的value==product id
            var total_all = 0;
            if (data_pos == -1) {
                $('#number' + curr).attr("readonly", "readonly");
                $('#price' + curr).text('0');
                $('#total' + curr).text('0');
                var curr_num = parseInt($('#number' + curr).val());
                var curr_total_num = parseInt($('#total_num').text());
                $('#number' + curr).val(0);
                $('#total_num').text(curr_total_num - curr_num);
                form.render();
            }
            else {
                $('#number' + curr).removeAttr("readonly");
                var pro_price = price[data_pos];
                $('#price' + curr).text(pro_price);
                if ($('#number' + curr).val() != "") {
                    var total_price = pro_price * $('#number' + curr).val();
                    $('#total' + curr).text(total_price);
                }
                form.render();
            }

            for (var i = 1; i <= curr; i++) {
                total_all += parseFloat($('#total' + i).text());
            }
            $('#total_price').text(total_all);
            $('#orderbill').val(total_all);
            form.render();
        });

        //监听province select
        form.on('select(province)', function (data) {
            var province_id = $('#province').val();
            if (province_id < 0) {
                $('#city').empty();
                $('#district').empty();
                form.render();
                return;
            }
            var city_data = getData(2);
            $('#city').empty();
            for (i in city_data) {
                $('#city').append('<option value="' + city_data[i].code + '">' + city_data[i].name + '</option>');
            }
            var city_id = $('#city').val();
            var district_data = getData(3);
            $('#district').empty();
            for (i in district_data) {
                $('#district').append('<option value="' + district_data[i].code + '">' + district_data[i].name + '</option>');
            }
            form.render();

        })
        //监听city select
        form.on('select(city)', function (data) {
            var city_id = $('#city').val();
            var district_data = getData(3);
            $('#district').empty();
            for (i in district_data) {
                $('#district').append('<option value="' + district_data[i].code + '">' + district_data[i].name + '</option>');
            }
            form.render();
        })

        //删除行
        window.removeTr = function (trNum) {
            console.log("remove clicked");
            $("#tr" + trNum).remove();
            num -= 1
        };


    });
    function getForm() {
        console.log(that_form)
    }
</script>


</html>