<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>添加订单-WeAdmin Frame型后台管理系统-WeAdmin 1.0</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../static/css/font.css">
    <link rel="stylesheet" href="../../static/css/weadmin.css">
    <script src="../../lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript">

    </script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
          <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
          <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

</head>

<body>

    <div class="weadmin-body">
        <fieldset class="layui-elem-field order-form">
            <!-- TODO: 居中、调整表格 -->
            <legend>
                <h1>新增订单</h1>
            </legend>
            <div class="layui-field-box">
                <h2>联系方式</h2>
                <hr class="layui-bg-green">
                <form class="layui-form">
                    <div class="layui-form-item">
                        <label for="contacter" class="layui-form-label">
                            <span class="we-red">*</span>公司名称
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="ordercomp" name="order-comp" placeholder="名称" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                        <label for="contacter" class="layui-form-label">
                            <span class="we-red">*</span>联系人
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="ordercontacter" name="order-contacter" placeholder="名称" lay-verify="required" autocomplete="off" class="layui-input">
                        </div>
                        <label for="contacter" class="layui-form-label">
                            <span class="we-red">*</span>手机号
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="ordertel" name="order-tel" placeholder="手机号码" lay-verify="required|phone" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="receiver" class="layui-form-label">
                            <span class="we-red">*</span>接单人
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="receiver" name="receiver" placeholder="名称" lay-verify="required|name" autocomplete="off" class="layui-input">
                        </div>

                        <label for="checker" class="layui-form-label">
                            <span class="we-red">*</span>审核人
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="check" name="check" placeholder="名称" lay-verify="required|name" autocomplete="off" class="layui-input">
                        </div>


                    </div>


                    <div class="layui-form-item">
                        <label for="begindate" class="layui-form-label">
                            <span class="we-red">*</span>下单日期
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="begindate" name="begindate" lay-verify="required|date" autocomplete="off" class="layui-input">
                        </div>
                        <label for="enddate" class="layui-form-label">
                            <span class="we-red">*</span>交付日期
                        </label>
                        <div class="layui-input-inline">
                            <input type="text" id="enddate" name="enddate" lay-verify="required|date" autocomplete="off" class="layui-input">
                        </div>
                    </div>




                    <div class="layui-form-item">
                        <label for="receive-addr" class="layui-form-label">
                            <span class="we-red">*</span>收货地址
                        </label>
                        <div class="layui-input-inline">
                            <select name="province" id="province" lay-filter="province">
                                <option value="110000">北京市</option>
                                <option value="120000">天津市</option>
                                <option value="130000">河北省</option>
                                <option value="140000">山西省</option>
                                <option value="150000">内蒙古自治区</option>
                                <option value="210000">辽宁省</option>
                                <option value="220000">吉林省</option>
                                <option value="230000">黑龙江</option>
                                <option value="310000">上海市</option>
                                <option value="320000">江苏省</option>
                                <option value="330000">浙江省</option>
                                <option value="340000">安徽省</option>
                                <option value="350000">福建省</option>
                                <option value="360000">江西省</option>
                                <option value="370000">山东省</option>
                                <option value="410000">河南省</option>
                                <option value="420000">湖北省</option>
                                <option value="430000">湖南省</option>
                                <option value="440000">广东省</option>
                                <option value="450000">广西壮族自治区</option>
                                <option value="460000">海南省</option>
                                <option value="500000">重庆市</option>
                                <option value="510000">四川省</option>
                                <option value="520000">贵州省</option>
                                <option value="530000">云南省</option>
                                <option value="540000">西藏自治区</option>
                                <option value="610000">陕西省</option>
                                <option value="620000">甘肃省</option>
                                <option value="630000">青海省</option>
                                <option value="640000">宁夏回族自治区</option>
                                <option value="650000">新疆维吾尔自治区</option>
                                <option value="710000">台湾省</option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="city" id="city" lay-filter="city">
                                <option></option>
                            </select>
                        </div>
                        <div class="layui-input-inline">
                            <select name="district" id="district" lay-filter="district">
                                <option></option>
                            </select>
                        </div>
                        <!--<input type="text" id="receive-addr" class="layui-input" name="receive-addr" lay-verify="required" autocomplete="off" style="width:500%">-->

                    </div>
                    <div class="layui-form-item">
                        <label for="receive-addr" class="layui-form-label">
                            <span class="we-red">*</span>详细地址
                        </label>
                        <div class="layui-input-inline">
                            <textarea placeholder="详细地址" id="address" name="desc" class="layui-textarea" style="width:400%"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label for="fapiao" class="layui-form-label">
                            订单总额
                        </label>
                        <div class="layui-input-inline">
                            <input readonly="value" type="text" id="orderbill" name="orderbill" class="layui-input">
                        </div>
                        <label for="payment" class="layui-form-label">
                            支付方式
                        </label>
                        <div class="layui-input-inline">
                            <select name="payment" id="payment">
                                <option value="1">现金</option>
                                <option value="2">银行转账</option>
                                <option value="3">支票</option>
                                <option value="4">微信</option>
                                <option value="5">支付宝</option>
                            </select>
                        </div>
                    </div>



                    <h2>订单明细</h2>
                    <hr class="layui-bg-green">

                    <div class="layui-form-item">
                        <table class="layui-table" id="myTable">
                            <thead>
                                <tr>
                                    <th>货品编号</th>
                                    <th>商品名称</th>
                                    <th>单价</th>
                                    <th>数量</th>
                                    <th>总价</th>
                                    <th>操作</th>
                                </tr>

                            </thead>
                            <tbody>

                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>合计</td>
                                    <td colspan>人民币</td>
                                    <td></td>
                                    <td id="total_num"></td>
                                    <td id="total_price"></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                        <a class="layui-btn layui-btn-sm" onclick="addTable();">
                            <i class="fas fa-plus"></i>+</a>
                    </div>
                    <div class="layui-form-item">
                        <textarea placeholder="备注：如有特殊需求，如 配送物流、加急订单等请在此注明" id="desc" name="desc" class="layui-textarea"></textarea>
                    </div>
                    <div class="layui-form-item">
                        <button class="layui-btn" lay-submit lay-filter="add">确定</button>
                    </div>
                </form>
            </div>
        </fieldset>

    </div>
</body>
<script>
    layui.extend({
        admin: '{/}../../static/js/admin'
    });
    layui.use(['form', 'admin', 'jquery', 'table', 'layer', 'laydate'], function () {
        var form = layui.form,
            admin = layui.admin,
            $ = layui.jquery,
            table = layui.table,
            laydate = layui.laydate
        layer = layui.layer;

        laydate.render({
            elem: '#enddate'
        });

        laydate.render({
            elem: '#begindate'
        });

        //获取数据
        function getData(type) {
            var post_data;
            var pdata;
            var province_id;
            var city_id;
            
            if(type == 1) {
                post_data = {
                    "req_type" : "product"
                };
            }
            else if(type == 2) {
                province_id = $('#province').val();
                post_data = {
                    "req_type" : "province", 
                    "province_id" : province_id
                };
            }
            else {
                province_id = $('#province').val();
                city_id = $("#city").val();
                post_data = {
                    "req_type" : "city", 
                    "province_id" : province_id,
                    "city_id" : city_id
                };
            }
            console.log(post_data);
            console.log(post_data.req_type);
            $.ajax({
                type: "POST",
                url: "http://39.106.107.66:2333",
                cache: false,
                async: false,
                contentType: "application/json",
                dataType : "jsonp",
                data: JSON.stringify(post_data),
                success: function (data) {
                    pdata = data;
                },
                error: function (err) {
                    console.log(err);   
                }
            })
            return pdata;
        };


        //监听提交
        form.on('submit(add)', function (data) {
            var comp_name = $("#ordercomp").val();
            var contacter = $("#ordercontacter").val();
            var tele_num = $("#ordertel").val();
            var begin_date = $("#begindate").val();
            var end_date = $("#enddate").val();
            var province = $("#province").val();
            var city = $("#city").val();
            var district = $("#district").val();
            var address = $("#address").val();
            var req_data = {
                "date": begin_date,
                "indentor": comp_name,
                "receiver": " "
            }
            layer.alert(JSON.stringify(data.field));
            $.ajax({
                async: false,
                cache: false,
                type: 'POST',
                url: '',
                error: function () {
                    console.log('请求失败');
                },
                success: function (req_data) {
                    console.log(req_data)
                }
            })
            return false;
        });



        var num = 1;
        var price = 0;
        var total = 0;
        var pro_data = {};
        var number = [];

        //动态添加订单明细
        window.addTable = function () {
            pro_data = getData(1);
            var tableHtml = "";

            tableHtml += '<tr id="tr' + num + '">' +
                '<td>' + num + '</td>' +
                '<td><div class="layui-input-inline"><select lay-filter="product" id="product' + num + '" class="product"><option value="-1">请选择</option></select></div></td>' +
                '<td><div class="layui-input-inline"><a id="price' + num + '">' + price + '</a></div></td>' +
                '<td><div class="layui-input-inline"><input type="text" readonly="value" placeholder="请输入" id="number' + num + '"class="layui-input" class="productnum"></input></div></td>' +
                '<td><div class="layui-input-inline"><a id="total' + num + '">' + total + '</div></td>' +
                '<td><button class="layui-btn layui-btn-danger layui-btn-sm" onclick="removeTr(' + num + ')">删除</button>' +
                '</td>' +
                '</tr>';

            var elements = $("#myTable").children().length; //表示id为“mtTable”的标签下的子标签的个数    
            $("#myTable").children().eq(elements - 1).after(tableHtml); //在表头之后添加空白行
            //动态向select添加option
            for (var i = 0; i < pro_data.length; i++) {
                $('#product' + num).append('<option value="' + i + '">' + pro_data[i].product_name + '</option>');
            }
            form.render("select");

            //动态监听input输入内容
            var $inputContainer = $('#myTable');
            $inputContainer.find('input').on('input proertychange', function () {
                var result = $(this).val();
                var id = $(this)[0].id;
                var curr = id.substr(6, id.length);
                var cur_price = $('#price' + curr).text();
                var total_price = cur_price * result;
                
                $('#total' + curr).text(cur_price * result);
                //total_num update
                var total_num = 0;
                var total_all = 0;
                for (var i = 1; i < num; i++) {
                    if ($('#number' + i).val() != "") {
                        total_num += parseInt($('#number' + i).val());
                        total_all += parseFloat($('#total' + i).text());
                    }
                }
                $('#total_num').text(total_num);
                $('#total_price').text(total_all);
                $('#orderbill').text(total_all);
                form.render();
            })
            num++;
        };

        //监听product select
        form.on('select(product)', function (data) {
            var id = $(data)[0].elem.id;
            var curr = id.substr(7, id.length);
            var data_pos = $('#' + id).val();
            var total_all = 0;
            if (data_pos < 0) {
                $('#number' + curr).attr("readonly", "readonly");
                $('#price' + curr).text('0');
                $('#total' + curr).text('0');
                var curr_num = parseInt($('#number' + curr).val());
                var curr_total_num = parseInt($('#total_num').text());
                console.log("curr_num : " + curr_num);
                console.log("curr_total_num : " + curr_total_num);
                $('#number' + curr).val('');
                $('#total_num').text(curr_total_num - curr_num);
                form.render();
            }
            else {
                $('#number' + curr).removeAttr("readonly");
                var price = pro_data[data_pos].price;
                $('#price' + curr).text(price);
                if ($('#number' + curr).val() != "") {
                    var price = pro_data[data_pos].price;
                    var total_price = price * $('#number' + curr).val();
                    $('#total' + curr).text(total_price);
                }
                form.render();
            }
            
            for(var i = 1; i <= curr; i ++) {
                total_all += parseFloat($('#total' + i).text());
            }
            $('#total_price').text(total_all);
            $('#orderbill').text(total_all);
            form.render();
        });

        //监听province select
        form.on('select(province)', function (data) {
           var province_id = $('#province').val();
           console.log(province_id);
           var city_data = getData(2);

        })



        //删除行
        function removeTr(trNum) {
            console.log("remove clicked");
            $("#tr" + trNum).remove();
        };


    });
</script>


</html>